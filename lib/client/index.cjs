var h=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var f=(n,t)=>{for(var e in t)h(n,e,{get:t[e],enumerable:!0})},x=(n,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of b(t))!w.call(n,s)&&s!==e&&h(n,s,{get:()=>t[s],enumerable:!(o=y(t,s))||o.enumerable});return n};var L=n=>x(h({},"__esModule",{value:!0}),n);var k={};f(k,{Connection:()=>a,KeepAliveClient:()=>l});module.exports=L(k);var r=class{constructor(t=2**16-1){this.ids=[];this.index=0;this.maxIndex=t}release(t){if(t<0||t>this.maxIndex)throw new TypeError(`ID must be between 0 and ${this.maxIndex}. Got ${t}.`);this.ids[t]=!1}reserve(){let t=this.index;for(;;){let e=this.index;if(!this.ids[e])return this.ids[e]=!0,e;if(this.index>=this.maxIndex?this.index=0:this.index++,this.index===t)throw new Error("All IDs are reserved. Make sure to release IDs when they are no longer used.")}}};var p=class{constructor(t,e){this.value=t,this.expireTime=Date.now()+e}get expiresIn(){return this.expireTime-Date.now()}get isExpired(){return Date.now()>this.expireTime}},d=class{constructor(){this.items=[]}add(t,e){this.items.push(new p(t,e))}get isEmpty(){let t=this.items.length;for(;t--;)if(this.items[t].isExpired)this.items.splice(t,1);else return!1;return!0}pop(){for(;this.items.length;){let t=this.items.shift();if(!t.isExpired)return t}return null}};var a=class extends EventTarget{constructor(e){super();this.ids=new r;this.queue=new d;this.callbacks={};this.socket=e,this.applyListeners()}sendToken(e,o){try{this.socket.send(JSON.stringify(e))}catch{this.queue.add(e,o)}}applyListeners(e=!1){let o=()=>{for(;!this.queue.isEmpty;){let s=this.queue.pop();this.sendToken(s.value,s.expiresIn)}};e&&o(),this.socket.onopen=(s,i)=>{o(),this.dispatchEvent(new Event("connection")),this.dispatchEvent(new Event("connected")),this.dispatchEvent(new Event("connect"))},this.socket.onclose=s=>{this.dispatchEvent(new Event("close")),this.dispatchEvent(new Event("closed")),this.dispatchEvent(new Event("disconnected")),this.dispatchEvent(new Event("disconnect"))},this.socket.onmessage=async s=>{try{let i=JSON.parse(s.data);this.dispatchEvent(new CustomEvent("message",{detail:i})),i.command==="latency:request"?(this.dispatchEvent(new CustomEvent("latency:request",{detail:{latency:i.payload.latency??void 0}})),this.command("latency:response",{latency:i.payload.latency??void 0},null)):i.command==="latency"?this.dispatchEvent(new CustomEvent("latency",{detail:{latency:i.payload??void 0}})):i.command==="ping"?(this.dispatchEvent(new CustomEvent("ping",{})),this.command("pong",{},null)):this.dispatchEvent(new CustomEvent(i.command,{detail:i.payload})),this.callbacks[i.id]&&this.callbacks[i.id](null,i.payload)}catch{this.dispatchEvent(new Event("error"))}}}async command(e,o,s=3e4,i=null){let c=this.ids.reserve(),E={id:c,command:e,payload:o??{}};if(this.sendToken(E,s),s===null){this.ids.release(c),delete this.callbacks[c];return}let m=this.createResponsePromise(c),u=this.createTimeoutPromise(c,s);if(typeof i=="function"){let v=await Promise.race([m,u]);return i(v),v}else return Promise.race([m,u])}createTimeoutPromise(e,o){return new Promise((s,i)=>{setTimeout(()=>{this.ids.release(e),delete this.callbacks[e],i(new Error(`Command ${e} timed out after ${o}ms.`))},o)})}createResponsePromise(e){return new Promise((o,s)=>{this.callbacks[e]=(i,c)=>{this.ids.release(e),delete this.callbacks[e],i?s(i):o(c)}})}};var g=(n={})=>(n.pingTimeout=n.pingTimeout??3e4,n.maxLatency=n.maxLatency??2e3,n.shouldReconnect=n.shouldReconnect??!0,n.reconnectInterval=n.reconnectInterval??2e3,n.maxReconnectAttempts=n.maxReconnectAttempts??1/0,n),l=class extends EventTarget{constructor(e,o={}){super();this.isReconnecting=!1;this.url=e,this.socket=new WebSocket(e),this.connection=new a(this.socket),this.options=g(o),this.applyListeners()}applyListeners(){this.connection.addEventListener("connection",()=>{this.heartbeat()}),this.connection.addEventListener("close",()=>{this.reconnect()}),this.connection.addEventListener("ping",()=>{this.heartbeat()}),this.connection.addEventListener("message",e=>{this.dispatchEvent(new CustomEvent("message",e))})}heartbeat(){clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{this.options.shouldReconnect&&this.reconnect()},this.options.pingTimeout+this.options.maxLatency)}async reconnect(){if(this.isReconnecting)return;this.isReconnecting=!0;let e=1;if(this.socket)try{this.socket.close()}catch{}let o=()=>{this.socket=new WebSocket(this.url),this.socket.onerror=()=>{e++,e<=this.options.maxReconnectAttempts?setTimeout(o,this.options.reconnectInterval):(this.isReconnecting=!1,this.connection.dispatchEvent(new Event("reconnectfailed")),this.connection.dispatchEvent(new Event("reconnectionfailed")))},this.socket.onopen=()=>{this.isReconnecting=!1,this.connection.socket=this.socket,this.connection.applyListeners(!0),this.connection.dispatchEvent(new Event("connection")),this.connection.dispatchEvent(new Event("connected")),this.connection.dispatchEvent(new Event("connect")),this.connection.dispatchEvent(new Event("reconnection")),this.connection.dispatchEvent(new Event("reconnected")),this.connection.dispatchEvent(new Event("reconnect"))}};o()}async command(e,o,s,i){return this.connection.command(e,o,s,i)}};0&&(module.exports={Connection,KeepAliveClient});
