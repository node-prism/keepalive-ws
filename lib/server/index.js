import{WebSocket as f,WebSocketServer as y}from"ws";var a=c=>{let d=new TextDecoder("utf-8").decode(c);if(!d)return{id:0,command:"",payload:{}};try{let e=JSON.parse(d);return{id:e.id,command:e.command,payload:e.payload}}catch{return{id:0,command:"",payload:{}}}};import g from"events";var m=class{constructor(){this.start=0;this.end=0;this.ms=0}onRequest(){this.start=Date.now()}onResponse(){this.end=Date.now(),this.ms=this.end-this.start}};var h=class{};var l=class extends g{constructor(e,t,n){super();this.alive=!0;this.socket=e,this.id=t.headers["sec-websocket-key"],this.remoteAddress=t.socket.remoteAddress,this.connectionOptions=n,this.applyListeners(),this.startIntervals()}startIntervals(){this.latency=new m,this.ping=new h,this.latency.interval=setInterval(()=>{this.alive&&(typeof this.latency.ms=="number"&&this.send({command:"latency",payload:this.latency.ms}),this.latency.onRequest(),this.send({command:"latency:request",payload:{}}))},this.connectionOptions.latencyInterval),this.ping.interval=setInterval(()=>{this.alive||this.emit("close"),this.alive=!1,this.send({command:"ping",payload:{}})},this.connectionOptions.pingInterval)}stopIntervals(){clearInterval(this.latency.interval),clearInterval(this.ping.interval)}applyListeners(){this.socket.on("close",()=>{this.emit("close")}),this.socket.on("message",e=>{let t=a(e);if(t.command==="latency:response"){this.latency.onResponse();return}else if(t.command==="pong"){this.alive=!0;return}this.emit("message",e)})}send(e){this.socket.send(JSON.stringify(e))}};var v=class{constructor(d,e,t){this.wss=d,this.connection=e,this.payload=t}},p=class extends y{constructor(e){super({...e});this.connections={};this.remoteAddressToConnections={};this.commands={};this.globalMiddlewares=[];this.middlewares={};this.rooms={};this.serverOptions={...e,pingInterval:e.pingInterval??3e4,latencyInterval:e.latencyInterval??5e3},this.applyListeners()}cleanupConnection(e){e.stopIntervals(),delete this.connections[e.id],this.remoteAddressToConnections[e.remoteAddress]&&(this.remoteAddressToConnections[e.remoteAddress]=this.remoteAddressToConnections[e.remoteAddress].filter(t=>t.id!==e.id)),this.remoteAddressToConnections[e.remoteAddress].length||delete this.remoteAddressToConnections[e.remoteAddress]}applyListeners(){this.on("connection",(e,t)=>{let n=new l(e,t,this.serverOptions);this.connections[n.id]=n,this.remoteAddressToConnections[n.remoteAddress]||(this.remoteAddressToConnections[n.remoteAddress]=[]),this.remoteAddressToConnections[n.remoteAddress].push(n),this.emit("connected",n),n.once("close",()=>{this.cleanupConnection(n),this.emit("close",n),e.readyState===f.OPEN&&e.close(),Object.keys(this.rooms).forEach(o=>{this.rooms[o].delete(n.id)})}),n.on("message",o=>{try{let{id:s,command:r,payload:i}=a(o);this.runCommand(s??0,r,i,n)}catch(s){this.emit("error",s)}})})}broadcast(e,t,n){let o=JSON.stringify({command:e,payload:t});if(n){n.forEach(s=>{s.socket.send(o)});return}Object.values(this.connections).forEach(s=>{s.socket.send(o)})}broadcastRemoteAddress(e,t,n){let o=JSON.stringify({command:t,payload:n});this.remoteAddressToConnections[e.remoteAddress].forEach(s=>{s.socket.send(o)})}broadcastRoom(e,t,n){let o=JSON.stringify({command:t,payload:n}),s=this.rooms[e];s&&s.forEach(r=>{let i=this.connections[r];i&&i.socket.send(o)})}broadcastExclude(e,t,n){let o=JSON.stringify({command:t,payload:n});Object.values(this.connections).forEach(s=>{s.id!==e.id&&s.socket.send(o)})}addToRoom(e,t){this.rooms[e]=this.rooms[e]??new Set,this.rooms[e].add(t.id)}removeFromRoom(e,t){this.rooms[e]&&this.rooms[e].delete(t.id)}getRoom(e){let t=this.rooms[e]||new Set;return Array.from(t).map(n=>this.connections[n])}clearRoom(e){this.rooms[e]=new Set}registerCommand(e,t,n=[]){this.commands[e]=t,this.prependMiddlewareToCommand(e,n)}prependMiddlewareToCommand(e,t){t.length&&(this.middlewares[e]=this.middlewares[e]||[],this.middlewares[e]=t.concat(this.middlewares[e]))}appendMiddlewareToCommand(e,t){t.length&&(this.middlewares[e]=this.middlewares[e]||[],this.middlewares[e]=this.middlewares[e].concat(t))}async runCommand(e,t,n,o){let s=new v(this,o,n);try{if(!this.commands[t])throw new Error(`Command [${t}] not found.`);if(this.globalMiddlewares.length)for(let i of this.globalMiddlewares)await i(s);if(this.middlewares[t])for(let i of this.middlewares[t])await i(s);let r=await this.commands[t](s);o.send({command:t,payload:r})}catch(r){let i={error:r.message??r??"Unknown error"};o.send({command:t,payload:i})}}};export{l as Connection,p as KeepAliveServer,v as WSContext};
